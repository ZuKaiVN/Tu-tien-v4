<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ƒê·∫°o Sƒ© Phi ThƒÉng v5.0 - Thi√™n √Çm ƒê·∫°o T·∫°ng</title>
    <style>
        :root {
            --bg-color: #0a0a1a;
            --panel-bg: #1a1a2e;
            --accent: #ffd700;
            --text-main: #f0f0f0;
            --text-dim: #aaa;
            --bar-bg: #2a2a3e;
            --hp-fill: #e53935;
            --shield-fill: #2196f3;
            --exp-fill: #43a047;
            --rare: #b388ff;
            --boss: #ff5252;
            --crit-color: #ffb74d;
            --gold-gradient: linear-gradient(135deg, #ffd700, #ff8c00);
            --heal-color: #00e676;
            --control-resist: #ba68c8;
        }

        * { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }
        
        body {
            margin: 0; padding: 0;
            background: linear-gradient(135deg, #0a0a1a 0%, #1a0033 100%);
            color: var(--text-main);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            height: 100vh; width: 100vw;
            overflow: hidden;
            display: flex; justify-content: center;
        }

        #game-wrapper {
            width: 100%; max-width: 1400px; height: 100%;
            display: flex; flex-direction: row;
            position: relative;
        }

        /* --- VISUAL PANEL (LEFT/TOP) --- */
        #visual-panel {
            flex: 1.2; position: relative;
            background: radial-gradient(ellipse at center, #1a0033 0%, #0a0a1a 70%);
            border-right: 2px solid rgba(255, 215, 0, 0.2);
            display: flex; flex-direction: column;
            align-items: center; justify-content: center;
            overflow: hidden;
        }

        #version-info {
            position: absolute; top: 5px; left: 5px; 
            font-size: 0.7rem; color: var(--text-dim); opacity: 0.8;
            z-index: 50;
            background: rgba(0,0,0,0.5); padding: 3px 8px; border-radius: 10px;
        }
        
        #fps-display {
            position: absolute; top: 5px; right: 5px;
            font-size: 0.7rem; color: #00ff00; font-family: monospace;
            z-index: 50; background: rgba(0,0,0,0.5); padding: 2px 5px; border-radius: 3px;
        }
        
        /* Sprites & Bars */
        .sprite-container { position: absolute; width: 120px; height: 140px; display: flex; flex-direction: column; align-items: center; }
        
        #player-container { bottom: 25%; left: 15%; z-index: 10; }
        #enemy-container { bottom: 25%; right: 15%; z-index: 5; }

        .sprite { 
            width: 80px; height: 80px; 
            transition: transform 0.1s, filter 0.2s;
            position: relative;
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
        }
        
        #player {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%234fc3f7"/><path d="M50 20 L30 80 L70 80 Z" fill="%230288d1"/><circle cx="50" cy="35" r="5" fill="%23ffffff"/></svg>');
            filter: drop-shadow(0 0 15px rgba(79, 195, 247, 0.6));
        }
        
        #player.hitting {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%23ff9800"/><path d="M50 20 L30 80 L70 80 Z" fill="%23ff5722"/><circle cx="50" cy="35" r="5" fill="%23ffffff"/><path d="M70 40 L90 30 L85 50 Z" fill="%23ffeb3b"/></svg>');
            transform: scale(1.1);
        }
        
        #player.hurt {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><circle cx="50" cy="50" r="40" fill="%23ef5350"/><path d="M50 20 L30 80 L70 80 Z" fill="%23c62828"/><circle cx="50" cy="35" r="5" fill="%23ffffff"/><path d="M40 45 Q45 40 50 45 Q55 50 60 45" stroke="%23ffffff" fill="none" stroke-width="2"/></svg>');
            filter: brightness(0.8) drop-shadow(0 0 10px rgba(239, 83, 80, 0.5));
        }
        
        #enemy {
            background-image: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><rect x="20" y="20" width="60" height="60" rx="10" fill="%23ef5350"/><rect x="30" y="30" width="40" height="20" fill="%23c62828"/><circle cx="40" cy="65" r="8" fill="%23711c1c"/><circle cx="60" cy="65" r="8" fill="%23711c1c"/></svg>');
            filter: drop-shadow(0 0 10px rgba(239, 83, 80, 0.4));
        }
        .is-boss { transform: scale(1.5); filter: drop-shadow(0 0 20px red) hue-rotate(300deg); }

        /* Health Bars in Scene */
        .mini-bar { width: 80px; height: 8px; background: #000; margin-bottom: 8px; border-radius: 4px; overflow: hidden; border: 1px solid #333; }
        .mini-fill { height: 100%; width: 100%; transition: width 0.1s; }
        .hp-fill { background: linear-gradient(90deg, var(--hp-fill), #ff8a80); }
        .shield-fill { background: linear-gradient(90deg, var(--shield-fill), #64b5f6); }

        /* Enemy Stats Text */
        #enemy-stats-text {
            position: absolute; top: 20%; right: 10%; 
            padding: 10px 15px; background: rgba(10, 10, 26, 0.8); 
            border-radius: 8px; font-size: 0.85rem;
            min-width: 180px; text-align: left;
            border: 1px solid rgba(255, 215, 0, 0.3);
            backdrop-filter: blur(5px);
        }
        #enemy-stats-text div { margin: 3px 0; }
        .boss-text { color: var(--boss); font-weight: bold; text-shadow: 0 0 5px rgba(255, 82, 82, 0.5); }

        /* Animations */
        .anim-atk { animation: lunge 0.15s forwards; }
        .anim-hit { animation: shake 0.2s forwards; }
        .anim-stun { filter: grayscale(1) brightness(0.5); animation: pulseStun 0.5s infinite alternate; }

        @keyframes lunge { 0% { transform: translateX(0); } 50% { transform: translateX(60px); } 100% { transform: translateX(0); } }
        @keyframes shake { 0%, 100% { transform: translateX(0); } 25% { transform: translateX(-8px); } 75% { transform: translateX(8px); } }
        @keyframes pulseStun { 0% { opacity: 0.5; } 100% { opacity: 0.8; } }

        /* Floating Text */
        .float-text {
            position: absolute; font-weight: 900; pointer-events: none;
            animation: floatUp 1.2s forwards; font-size: 1.3rem;
            text-shadow: 0 3px 6px rgba(0,0,0,0.9); z-index: 20;
            white-space: nowrap;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .crit-text { color: var(--crit-color) !important; font-size: 1.8rem; animation: floatUp 1.5s forwards; }
        .evade-text { color: #00ff00 !important; font-size: 1.8rem; text-shadow: 0 0 10px #00ff00; }
        .heal-text { color: var(--heal-color) !important; font-size: 1.5rem; }
        @keyframes floatUp { 
            0% { transform: translateY(0) scale(0.8); opacity: 1; } 
            50% { transform: translateY(-30px) scale(1.1); opacity: 1; }
            100% { transform: translateY(-80px) scale(1); opacity: 0; } 
        }

        /* --- UI PANEL (RIGHT/BOTTOM) --- */
        #ui-panel {
            flex: 1; background: linear-gradient(135deg, var(--panel-bg) 0%, #16213e 100%);
            padding: 20px; display: flex; flex-direction: column;
            gap: 15px; overflow-y: auto; border-left: 2px solid rgba(255, 215, 0, 0.2);
        }

        /* Header */
        .header-row { 
            display: flex; justify-content: space-between; align-items: center; 
            border-bottom: 2px solid rgba(255, 215, 0, 0.3); 
            padding-bottom: 15px;
            background: linear-gradient(90deg, rgba(26,26,46,0.8) 0%, rgba(22,33,62,0.8) 100%);
            padding: 15px; border-radius: 10px;
        }
        #realm-info h2 { margin: 0; color: var(--accent); font-size: 1.6rem; text-shadow: 0 0 10px rgba(255, 215, 0, 0.3); }
        #realm-info p { margin: 5px 0 0 0; color: var(--text-dim); font-size: 1rem; }
        
        .header-btns { display: flex; gap: 10px; }
        .header-btn { 
            padding: 8px 16px; font-size: 0.9rem; font-weight: bold;
            cursor: pointer; border-radius: 6px; border: 1px solid rgba(255, 215, 0, 0.3);
            background: rgba(42, 42, 62, 0.8); color: #fff; transition: all 0.3s;
            backdrop-filter: blur(5px);
        }
        .header-btn:hover { background: rgba(255, 215, 0, 0.2); transform: translateY(-2px); }
        .btn-menu { 
            background: var(--gold-gradient); 
            color: #000;
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 0 15px rgba(255, 165, 0, 0.5);
        }
        .btn-menu:hover { background: linear-gradient(135deg, #ffe066, #ffb300); box-shadow: 0 0 20px rgba(255, 215, 0, 0.7); }

        /* Bars */
        .main-bar {
            width: 100%; height: 28px; background: var(--bar-bg);
            border-radius: 6px; position: relative; overflow: hidden;
            box-shadow: inset 0 0 10px rgba(0,0,0,0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .main-fill { height: 100%; width: 0%; transition: width 0.3s ease-out; }
        .bar-text {
            position: absolute; inset: 0; display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem; font-weight: bold; text-shadow: 1px 1px 3px black; z-index: 2; pointer-events: none;
        }

        /* Stats Grid */
        .stats-grid {
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px;
            background: rgba(10, 10, 26, 0.5); padding: 15px; border-radius: 10px;
            border: 1px solid rgba(255, 215, 0, 0.1);
            backdrop-filter: blur(5px);
        }
        .stat-box { 
            text-align: center; padding: 8px; 
            background: rgba(26, 26, 46, 0.5); border-radius: 6px;
            transition: transform 0.2s;
        }
        .stat-box:hover { transform: translateY(-3px); background: rgba(42, 42, 62, 0.7); }
        .stat-label { font-size: 0.75rem; color: #aaa; text-transform: uppercase; letter-spacing: 1px; }
        .stat-val { font-size: 1.1rem; font-weight: bold; color: #eee; margin-top: 5px; }
        .c-gold { color: var(--accent); text-shadow: 0 0 5px rgba(255, 215, 0, 0.5); }

        /* Buttons */
        .btn {
            border: none; border-radius: 8px; padding: 14px; font-weight: bold;
            cursor: pointer; color: #fff; background: rgba(42, 42, 62, 0.8); 
            transition: all 0.3s; font-size: 1rem; position: relative; overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(5px);
        }
        .btn:active { transform: scale(0.98); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .btn-gold { 
            background: var(--gold-gradient); 
            color: #000;
            box-shadow: 0 0 15px rgba(255, 165, 0, 0.5); 
            border: 1px solid rgba(255, 215, 0, 0.5);
        }
        .btn-gold:hover { box-shadow: 0 0 25px rgba(255, 215, 0, 0.7); transform: translateY(-3px); }
        
        .btn-blue { 
            background: linear-gradient(135deg, #1976d2, #0d47a1); 
            border: 1px solid rgba(100, 181, 246, 0.3);
        }
        .btn-blue:hover { box-shadow: 0 0 15px rgba(25, 118, 210, 0.5); }
        
        .controls { display: flex; gap: 15px; margin: 10px 0; }
        .controls .btn { flex: 1; }

        /* Skills */
        .skills-section { 
            display: grid; grid-template-columns: repeat(4, 1fr); gap: 12px; 
            margin: 10px 0; 
        }
        .skill-card {
            background: linear-gradient(135deg, rgba(42,42,62,0.8) 0%, rgba(26,26,46,0.8) 100%);
            border: 1px solid rgba(255, 215, 0, 0.2);
            border-radius: 8px; padding: 10px; position: relative;
            display: flex; flex-direction: column; align-items: center;
            transition: transform 0.2s;
        }
        .skill-card:hover { transform: translateY(-5px); border-color: rgba(255, 215, 0, 0.4); }
        .skill-icon {
            width: 100%; height: 50px; background: rgba(55, 71, 79, 0.5);
            display: flex; align-items: center; justify-content: center;
            font-size: 0.9rem; margin-bottom: 8px; cursor: pointer;
            position: relative; overflow: hidden;
            border-radius: 5px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .skill-icon.ready { background: rgba(76, 175, 80, 0.2); border-color: rgba(76, 175, 80, 0.3); }
        .skill-cooldown {
            position: absolute; bottom: 0; left: 0; width: 100%; height: 0%;
            background: rgba(0,0,0,0.7); transition: height 0.1s linear;
        }
        .upgrade-btn {
            width: 100%; font-size: 0.8rem; padding: 6px;
            background: rgba(68, 68, 68, 0.5); border: 1px solid rgba(255, 255, 255, 0.1);
            color: #bbb; cursor: pointer; border-radius: 4px;
            transition: all 0.2s;
        }
        .upgrade-btn:hover { background: rgba(85, 85, 85, 0.7); color: #fff; }

        /* Tabs */
        .tabs { 
            display: flex; border-bottom: 2px solid rgba(255, 215, 0, 0.2);
            background: rgba(26,26,46,0.5); border-radius: 8px 8px 0 0;
            overflow: hidden;
        }
        .tab { 
            flex: 1; padding: 12px; text-align: center; cursor: pointer; 
            color: #888; transition: all 0.3s; font-weight: bold;
            border-right: 1px solid rgba(255, 255, 255, 0.1);
        }
        .tab:last-child { border-right: none; }
        .tab.active { 
            color: var(--accent); background: rgba(255, 215, 0, 0.1);
            border-bottom: 3px solid var(--accent);
            text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
        }
        .tab:hover:not(.active) { background: rgba(255, 255, 255, 0.05); color: #ccc; }

        .scroll-area {
            flex: 1; background: rgba(10, 10, 26, 0.5);
            overflow-y: auto; padding: 15px; border-radius: 0 0 8px 8px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            font-size: 0.95rem;
            border: 1px solid rgba(255, 215, 0, 0.1);
            border-top: none;
        }
        .shop-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            transition: background 0.2s;
        }
        .shop-item:hover { background: rgba(255, 255, 255, 0.05); }
        .shop-item:last-child { border-bottom: none; }

        /* Modal */
        .modal {
            position: fixed; inset: 0; background: rgba(0,0,0,0.9);
            backdrop-filter: blur(10px); 
            display: none; align-items: center; justify-content: center; z-index: 100;
        }
        .modal.active { display: flex; }
        .modal-content {
            background: linear-gradient(135deg, #2c2c2c 0%, #1a1a2e 100%);
            width: 90%; max-width: 600px;
            padding: 30px; border-radius: 15px; 
            border: 2px solid var(--accent);
            box-shadow: 0 0 40px rgba(255, 215, 0, 0.3);
            display: flex; flex-direction: column; gap: 20px;
            max-height: 90vh; overflow-y: auto;
            transform: scale(0.95); opacity: 0; transition: all 0.3s ease-out;
        }
        .modal.active .modal-content { transform: scale(1); opacity: 1; }
        
        .modal-title { 
            font-size: 1.8rem; margin-bottom: 10px; color: var(--accent); 
            text-align: center; text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
            border-bottom: 2px solid rgba(255, 215, 0, 0.3); padding-bottom: 15px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .modal-section-title {
            color: #64b5f6; margin: 15px 0 8px 0; font-size: 1.2rem;
            border-bottom: 1px dashed rgba(100, 181, 246, 0.3); padding-bottom: 8px;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .setting-item { 
            display: flex; justify-content: space-between; align-items: center; 
            padding: 10px 0; border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        .slider { 
            width: 50%; 
            background: rgba(255, 255, 255, 0.1); 
            border-radius: 10px;
            height: 8px;
            -webkit-appearance: none;
        }
        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px; height: 20px;
            border-radius: 50%;
            background: var(--accent);
            cursor: pointer;
        }

        /* Info Grid in Modal */
        .info-grid { 
            display: grid; grid-template-columns: 1fr 1fr; gap: 12px; 
            font-size: 0.95rem; 
        }
        .info-row { 
            display: flex; justify-content: space-between; 
            border-bottom: 1px solid rgba(255, 255, 255, 0.1); 
            padding: 8px 0; 
        }
        .info-label { color: #aaa; }
        .info-val { color: #fff; font-weight: bold; }

        /* Guide & Updates */
        #tab-guide h3, #tab-updates h3 { 
            color: var(--accent); margin: 15px 0 8px 0; 
            border-bottom: 1px dashed rgba(255, 215, 0, 0.3); 
            padding-bottom: 5px; 
        }
        #tab-guide p, #tab-updates p { margin: 8px 0; color: #ccc; line-height: 1.5; }
        .tip-box { 
            background: rgba(255, 215, 0, 0.1); 
            border-left: 4px solid var(--accent); 
            padding: 12px; margin: 15px 0;
            border-radius: 0 5px 5px 0;
        }
        .update-note {
            background: rgba(100, 181, 246, 0.1);
            border-left: 4px solid #64b5f6;
            padding: 10px; margin: 10px 0;
            border-radius: 0 5px 5px 0;
        }

        /* Music Player */
        #music-player {
            position: absolute; bottom: 10px; left: 50%;
            transform: translateX(-50%);
            background: rgba(0,0,0,0.7); padding: 8px 15px;
            border-radius: 20px; display: flex; align-items: center;
            gap: 10px; z-index: 50;
            border: 1px solid rgba(255, 215, 0, 0.3);
        }
        #music-toggle {
            background: none; border: none; color: var(--accent);
            cursor: pointer; font-size: 1.2rem;
        }
        #music-title {
            font-size: 0.8rem; color: #aaa;
        }

        /* New Stats Indicators */
        .stat-indicator {
            display: inline-block;
            width: 8px; height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        .hp-regen-indicator { background: var(--heal-color); }
        .control-resist-indicator { background: var(--control-resist); }

        /* Responsive */
        @media (max-width: 768px) {
            #game-wrapper { flex-direction: column; }
            #visual-panel { height: 40vh; flex: none; border-right: none; border-bottom: 2px solid rgba(255, 215, 0, 0.2); }
            #ui-panel { height: 60vh; flex: none; }
            .stats-grid { grid-template-columns: repeat(2, 1fr); font-size: 0.9rem; }
            .skills-section { grid-template-columns: repeat(2, 1fr); }
            .modal-content { width: 95%; padding: 20px; }
            .info-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>

<div id="version-info">Phi√™n b·∫£n: 5.0.0 - Thi√™n √Çm ƒê·∫°o T·∫°ng</div>
<div id="fps-display">FPS: 60</div>

<div id="game-wrapper">
    <div id="visual-panel">
        <div style="position: absolute; top: 10px; color: rgba(255,215,0,0.5); letter-spacing: 4px; font-size: 0.9rem; text-shadow: 0 0 10px rgba(255,215,0,0.3);">C·∫¢NH GI·ªöI TU LUY·ªÜN</div>
        
        <div id="player-container" class="sprite-container">
            <div class="mini-bar"><div id="v-shield-bar" class="mini-fill shield-fill" style="width: 100%"></div></div>
            <div id="player" class="sprite"></div>
        </div>

        <div id="enemy-container" class="sprite-container">
            <div class="mini-bar"><div id="v-hp-bar" class="mini-fill hp-fill" style="width: 100%"></div></div>
            <div id="enemy" class="sprite"></div>
            <div id="enemy-stats-text"></div>
        </div>

        <div id="float-layer"></div>
        
        <div id="music-player">
            <button id="music-toggle">‚ñ∂Ô∏è</button>
            <div id="music-title">Nh·∫°c n·ªÅn: Thi√™n √Çm</div>
        </div>
    </div>

    <div id="ui-panel">
        <div class="header-row">
            <div id="realm-info">
                <h2 id="realm-name">Ph√†m Nh√¢n</h2>
                <p id="stage-name">Giai ƒêo·∫°n 1</p>
            </div>
            <div class="header-btns">
                <button class="header-btn" onclick="ui.toggleDetailModal()">CHI TI·∫æT</button>
                <button class="header-btn btn-menu" onclick="ui.toggleMenu()">MENU</button>
            </div>
        </div>

        <div class="main-bar" style="background: #1a1a2e;">
            <div id="exp-bar" class="main-fill" style="background: linear-gradient(90deg, var(--exp-fill), #66bb6a);"></div>
            <div id="exp-text" class="bar-text">0 / 10 EXP</div>
        </div>

        <div class="stats-grid">
            <div class="stat-box"><div class="stat-label">T·ªëc ƒê·ªô EXP</div><div id="val-rate" class="stat-val">0/s</div></div>
            <div class="stat-box"><div class="stat-label">Linh Th·∫°ch</div><div id="val-stones" class="stat-val c-gold">0</div></div>
            <div class="stat-box"><div class="stat-label">T·∫•n C√¥ng</div><div id="val-atk" class="stat-val">1</div></div>
            <div class="stat-box"><div class="stat-label">Khi√™n T·ªëi ƒêa</div><div id="val-shield" class="stat-val" style="color:#64b5f6">10</div></div>
            <div class="stat-box"><div class="stat-label">T·ªëc ƒê·ªô ƒê√°nh</div><div id="val-spd" class="stat-val">1.0s</div></div>
            <div class="stat-box"><div class="stat-label">Ch√≠ M·∫°ng</div><div id="val-crit" class="stat-val" style="color:var(--crit-color)">5%</div></div>
            <div class="stat-box"><div class="stat-label">H√∫t M√°u</div><div id="val-lifesteal" class="stat-val" style="color:#e57373">0%</div></div> 
            <div class="stat-box"><div class="stat-label">N√© Tr√°nh</div><div id="val-evasion" class="stat-val" style="color:#4caf50">0%</div></div> 
            <div class="stat-box"><div class="stat-label">Ph·∫£n ƒê√≤n</div><div id="val-reflect" class="stat-val" style="color:#ff9800">0%</div></div>
            <div class="stat-box"><div class="stat-label">H·ªìi M√°u</div><div id="val-hp-regen" class="stat-val" style="color:var(--heal-color)">0/s</div></div> 
            <div class="stat-box"><div class="stat-label">Kh√°ng Control</div><div id="val-control-resist" class="stat-val" style="color:var(--control-resist)">0%</div></div>
            <div class="stat-box"><div class="stat-label">S√°t Th∆∞∆°ng Boss</div><div id="val-boss-dmg" class="stat-val" style="color:#ff5252">100%</div></div>
            <div class="stat-box"><div class="stat-label">S·ªë L·∫ßn ƒê√°nh</div><div id="val-multihit" class="stat-val" style="color:#b388ff">1</div></div>
        </div>

        <div class="controls">
            <button class="btn btn-blue" id="btn-cultivate" onclick="game.toggleCultivate()">Tu Luy·ªán: B·∫¨T</button>
            <button class="btn btn-gold" id="btn-break" onclick="game.breakthrough()" disabled>ƒê·ªòT PH√Å C·∫¢NH GI·ªöI</button>
        </div>

        <div class="skills-section">
            <div class="skill-card">
                <div class="skill-icon" onclick="game.activateSkill('strike')">
                    <span id="label-strike">L√¥i Ch∆∞·ªüng</span>
                    <div id="cd-strike" class="skill-cooldown"></div>
                </div>
                <button class="upgrade-btn" onclick="game.upgradeSkill('strike')">N√¢ng: <span id="cost-strike">100</span> LT</button>
            </div>
            <div class="skill-card">
                <div class="skill-icon" onclick="game.activateSkill('haste')">
                    <span id="label-haste">Gia T·ªëc</span>
                    <div id="cd-haste" class="skill-cooldown"></div>
                </div>
                <button class="upgrade-btn" onclick="game.upgradeSkill('haste')">N√¢ng: <span id="cost-haste">200</span> LT</button>
            </div>
            <div class="skill-card">
                <div class="skill-icon" onclick="game.activateSkill('cleanse')">
                    <span id="label-cleanse">Thanh T√¢m</span>
                    <div id="cd-cleanse" class="skill-cooldown"></div>
                </div>
                <button class="upgrade-btn" onclick="game.upgradeSkill('cleanse')">N√¢ng: <span id="cost-cleanse">500</span> LT</button>
            </div>
            <div class="skill-card">
                <div class="skill-icon" onclick="game.activateSkill('vortex')">
                    <span id="label-vortex">Kim Cang</span>
                    <div id="cd-vortex" class="skill-cooldown"></div>
                </div>
                <button class="upgrade-btn" onclick="game.upgradeSkill('vortex')">N√¢ng: <span id="cost-vortex">1000</span> LT</button>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active" onclick="ui.setTab('log')">Nh·∫≠t K√Ω</div>
            <div class="tab" onclick="ui.setTab('shop')">Linh ƒêi·ªÅn</div>
            <div class="tab" onclick="ui.setTab('guide')">S·ªï Tay</div>
            <div class="tab" onclick="ui.setTab('updates')">C·∫≠p Nh·∫≠t</div>
        </div>
        
        <div id="tab-log" class="scroll-area">
            <div style="color:var(--accent); font-weight:bold;">[5.0.0] C·∫≠p nh·∫≠t Thi√™n √Çm ƒê·∫°o T·∫°ng.</div>
            <div style="color:var(--accent);">Ch√†o m·ª´ng H·ªØu ƒë·∫øn v·ªõi phi√™n b·∫£n 5.0!</div>
        </div>
        
        <div id="tab-shop" class="scroll-area" style="display:none;"></div>
        
        <div id="tab-guide" class="scroll-area" style="display:none;">
            <h3>üåü H∆Ø·ªöNG D·∫™N C∆† B·∫¢N</h3>
            <div class="tip-box">
                <strong>M·ª•c ti√™u:</strong> Tu luy·ªán v√† ƒë·ªôt ph√° qua c√°c c·∫£nh gi·ªõi ƒë·ªÉ tr·ªü th√†nh ƒê·∫°o Sƒ© Phi ThƒÉng.
            </div>
            
            <h3>‚öîÔ∏è H·ªÜ TH·ªêNG CHI·∫æN ƒê·∫§U</h3>
            <p><strong>Khi√™n (Shield):</strong> Thay v√¨ m√°u, b·∫°n c√≥ khi√™n. Khi khi√™n = 0, b·∫°n b·ªã cho√°ng.</p>
            <p><strong>Ch√≠ M·∫°ng (Crit):</strong> T·ªâ l·ªá g√¢y s√°t th∆∞∆°ng g·∫•p ƒë√¥i.</p>
            <p><strong>H√∫t M√°u (Lifesteal):</strong> H·ªìi khi√™n khi t·∫•n c√¥ng.</p>
            <p><strong>N√© Tr√°nh (Evasion):</strong> Tr√°nh ho√†n to√†n s√°t th∆∞∆°ng.</p>
            <p><strong>Ph·∫£n ƒê√≤n (Reflect):</strong> Ph·∫£n l·∫°i % s√°t th∆∞∆°ng nh·∫≠n v√†o.</p>
            
            <h3>üß† CH·ªà S·ªê M·ªöI (v5.0)</h3>
            <p><span class="stat-indicator hp-regen-indicator"></span> <strong>H·ªìi M√°u:</strong> T·ª± ƒë·ªông h·ªìi khi√™n m·ªói gi√¢y.</p>
            <p><span class="stat-indicator control-resist-indicator"></span> <strong>Kh√°ng Control:</strong> Gi·∫£m th·ªùi gian b·ªã cho√°ng.</p>
            <p><strong>S·ªë L·∫ßn ƒê√°nh:</strong> ƒê√°nh nhi·ªÅu l·∫ßn trong m·ªôt l∆∞·ª£t.</p>
        </div>
        
        <div id="tab-updates" class="scroll-area" style="display:none;">
            <h3>üìú L·ªäCH S·ª¨ C·∫¨P NH·∫¨T</h3>
            
            <h3>üéµ VERSION 5.0 - THI√äN √ÇM ƒê·∫†O T·∫†NG</h3>
            <div class="update-note">
                <strong>Ph√°t h√†nh:</strong> Ng√†y ƒë·∫πp tr·ªùi
            </div>
            
            <h4>üéº H·ªÜ TH·ªêNG NH·∫†C N·ªÄN M·ªöI</h4>
            <ul>
                <li><strong>3 b√†i nh·∫°c n·ªÅn chuy√™n nghi·ªáp:</strong> Thi√™n √Çm, U Minh, ƒê·∫°o T·∫°ng</li>
                <li><strong>ƒêi·ªÅu khi·ªÉn nh·∫°c:</strong> Play/Pause, chuy·ªÉn b√†i, ch·ªânh volume</li>
                <li><strong>Hi·ªÉn th·ªã t√™n b√†i:</strong> Xem t√™n b√†i ƒëang ph√°t</li>
            </ul>
            
            <h4>üõí 20 V·∫¨T PH·∫®M SHOP M·ªöI</h4>
            <ul>
                <li><strong>H·ªìi M√°u:</strong> H·ªìi Nguy√™n ƒêan, Linh Tuy·ªÅn Th·ªßy</li>
                <li><strong>Kh√°ng Control:</strong> T√¢m Linh H·ªô Ph√π, ƒê·ªãnh Th·∫ßn Ch√¢u</li>
                <li><strong>ƒêa Tr√∫ng:</strong> Ph√¢n Th√¢n H·ªô, ·∫¢nh Ki·∫øm Thu·∫≠t</li>
                <li><strong>S√°t Th∆∞∆°ng Boss:</strong> Tr·∫£m Y√™u Ki·∫øm, Di·ªát Ma Ch√πy</li>
                <li><strong>V·∫≠t ph·∫©m cao c·∫•p:</strong> H·ªón ƒê·ªôn Linh B·∫£o, V·∫°n C·ªï ƒêan L√¥</li>
            </ul>
            
            <h4>üë§ H√åNH ·∫¢NH NH√ÇN V·∫¨T</h4>
            <ul>
                <li><strong>3 tr·∫°ng th√°i:</strong> B√¨nh th∆∞·ªùng, t·∫•n c√¥ng, b·ªã ƒë√°nh</li>
                <li><strong>Hi·ªáu ·ª©ng h√¨nh ·∫£nh:</strong> M√†u s·∫Øc v√† filter ƒë·ªông</li>
                <li><strong>Animation m∆∞·ª£t m√†:</strong> Chuy·ªÉn ti·∫øp tr·∫°ng th√°i</li>
            </ul>
            
            <h4>üìä CH·ªà S·ªê M·ªöI</h4>
            <ul>
                <li><strong>H·ªìi M√°u (HP Regen):</strong> T·ª± ƒë·ªông h·ªìi khi√™n</li>
                <li><strong>Kh√°ng Control (Control Resist):</strong> Gi·∫£m th·ªùi gian cho√°ng</li>
                <li><strong>S·ªë L·∫ßn ƒê√°nh (Multihit):</strong> ƒê√°nh nhi·ªÅu l·∫ßn m·ªói l∆∞·ª£t</li>
                <li><strong>S√°t Th∆∞∆°ng Boss (Boss Damage):</strong> TƒÉng s√°t th∆∞∆°ng l√™n boss</li>
            </ul>
            
            <h4>üéÆ C·∫¢I THI·ªÜN KH√ÅC</h4>
            <ul>
                <li>UI/UX c·∫£i ti·∫øn v·ªõi gradient v√† blur effects</li>
                <li>Animation m∆∞·ª£t m√† h∆°n</li>
                <li>Hi·ªáu ·ª©ng h√¨nh ·∫£nh phong ph√∫</li>
                <li>T·ªëi ∆∞u hi·ªáu nƒÉng</li>
            </ul>
            
            <div class="tip-box">
                <strong>Ghi ch√∫:</strong> T·∫•t c·∫£ thay ƒë·ªïi ƒë∆∞·ª£c ƒë·ªìng b·ªô trong b·∫£ng "Chi Ti·∫øt" (Thi√™n Nh√£n Chi Thu·∫≠t).
            </div>
        </div>
    </div>
</div>

<!-- Main Menu Modal -->
<div id="main-menu-modal" class="modal" onclick="if(event.target === this) ui.toggleMenu()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-title">MENU CH√çNH - THI√äN √ÇM ƒê·∫†O T·∫†NG</div>
        
        <h3 class="modal-section-title">üéµ H·ªÜ TH·ªêNG NH·∫†C</h3>
        <div class="setting-item">
            <span>B√†i nh·∫°c:</span>
            <select id="music-select" style="padding:6px; background:rgba(68,68,68,0.8); color:#fff; border:1px solid rgba(255,255,255,0.1); border-radius:4px;">
                <option value="0">Thi√™n √Çm (M·∫∑c ƒë·ªãnh)</option>
                <option value="1">U Minh C·ªï Kh√∫c</option>
                <option value="2">ƒê·∫°o T·∫°ng Ch√¢n Kinh</option>
            </select>
        </div>
        <div class="setting-item">
            <span>Nh·∫°c N·ªÅn:</span>
            <input type="range" min="0" max="100" value="50" class="slider" id="music-volume" oninput="audio.setVolume('music', this.value)">
        </div>
        <div class="setting-item">
            <span>Hi·ªáu ·ª®ng:</span>
            <input type="range" min="0" max="100" value="100" class="slider" id="sfx-volume" oninput="audio.setVolume('sfx', this.value)">
        </div>

        <h3 class="modal-section-title">üñ•Ô∏è HI·ªÜU NƒÇNG</h3>
        <div class="setting-item">
            <span>Gi·ªõi h·∫°n FPS:</span>
            <select id="fps-select" style="padding:6px; background:rgba(68,68,68,0.8); color:#fff; border:1px solid rgba(255,255,255,0.1); border-radius:4px;" onchange="game.setFPS(this.value)">
                <option value="30">30 FPS (Ti·∫øt ki·ªám pin)</option>
                <option value="60" selected>60 FPS (C√¢n b·∫±ng)</option>
                <option value="120">120 FPS (M∆∞·ª£t)</option>
                <option value="0">Kh√¥ng gi·ªõi h·∫°n</option>
            </select>
        </div>

        <h3 class="modal-section-title">üíæ D·ªÆ LI·ªÜU</h3>
        <button class="btn btn-blue" onclick="game.save(true)">üíæ L∆ØU GAME</button>
        <div style="display:flex; gap:10px; margin-top:10px;">
            <button class="btn" onclick="game.exportSave()" style="flex:1; background:rgba(85,85,85,0.8)">Xu·∫•t Save</button>
            <button class="btn" onclick="game.importSave()" style="flex:1; background:rgba(85,85,85,0.8)">Nh·∫≠p Save</button>
        </div>

        <h3 class="modal-section-title" style="color:#ff8a65">‚ö†Ô∏è NGUY HI·ªÇM</h3>
        <button class="btn" style="background:rgba(211,47,47,0.8)" onclick="game.hardReset()">üóëÔ∏è X√ìA TO√ÄN B·ªò D·ªÆ LI·ªÜU</button>
        
        <button class="btn btn-gold" style="margin-top: 20px;" onclick="ui.toggleMenu()">ƒê√ìNG</button>
    </div>
</div>

<!-- Detail Modal -->
<div id="detail-modal" class="modal" onclick="if(event.target === this) ui.toggleDetailModal()">
    <div class="modal-content" onclick="event.stopPropagation()">
        <div class="modal-title">THI√äN NH√ÉN CHI THU·∫¨T</div>
        
        <h3 class="modal-section-title" style="color: var(--accent)">üßò ƒê·∫†O H·ªÆU (STATS)</h3>
        <div class="info-grid" id="player-details">
            <!-- Filled by JavaScript -->
        </div>

        <h3 class="modal-section-title" style="color: #ef5350">üëπ K·∫∫ ƒê·ªäCH HI·ªÜN T·∫†I</h3>
        <div class="info-grid" id="enemy-details">
            <!-- Filled by JavaScript -->
        </div>
        
        <h3 class="modal-section-title" style="color: #4caf50">üìà TH·ªêNG K√ä N√ÇNG CAO</h3>
        <div class="info-grid" id="advanced-stats">
            <!-- Filled by JavaScript -->
        </div>
        
        <button class="btn btn-gold" style="margin-top: 20px;" onclick="ui.toggleDetailModal()">ƒê√ìNG</button>
    </div>
</div>

<script>
/* --- CONSTANTS --- */
const VERSION = "5.0.0";

const REALMS = [
    { name: "Ph√†m Nh√¢n", exp: 10, stages: 1 },
    { name: "Luy·ªán Th·ªÉ", exp: 2000, stages: 9 },
    { name: "Ng∆∞ng Kh√≠", exp: 15000, stages: 9 },
    { name: "Tr√∫c C∆°", exp: 80000, stages: 12 }, 
    { name: "K·∫øt ƒêan", exp: 500000, stages: 12 },
    { name: "Nguy√™n Anh", exp: 5000000, stages: 12 },
    { name: "Ph√¢n Th·∫ßn", exp: 75000000, stages: 12 },
    { name: "V·∫•n ƒê·∫°o", exp: 500000000, stages: 12 },
    { name: "Phi ThƒÉng Ti√™n Gi·ªõi", exp: 10000000000, stages: 100 }
];

// 40 items total (20 original + 20 new)
const SHOP = [
    // --- EXP & Resource (Original) ---
    { id: 'incense', name: 'Linh H∆∞∆°ng Th·∫£o', desc: '+5 EXP/s c∆° b·∫£n', baseCost: 15, type: 'exp_flat', val: 5 },
    { id: 'scroll', name: 'C·ªï Th∆∞ Exp', desc: '+10% EXP nh·∫≠n', baseCost: 1000, type: 'exp_mult', val: 0.1 },
    { id: 'stone_mult', name: 'ƒêan D∆∞·ª£c T√†i Nguy√™n', desc: '+10% Linh Th·∫°ch nh·∫≠n', baseCost: 500, type: 'stone_mult', val: 0.1 },
    { id: 'meditation', name: 'Tƒ©nh T√¢m Ph√π', desc: '+1% Hi·ªáu su·∫•t tu luy·ªán', baseCost: 2000, type: 'exp_mult', val: 0.01 },
    { id: 'mana_spring', name: 'Linh M·∫°ch Mini', desc: '+20 EXP/s c∆° b·∫£n', baseCost: 10000, type: 'exp_flat', val: 20 },
    
    // --- OFFENSE (Original) ---
    { id: 'sword', name: 'Thi·∫øt Ki·∫øm', desc: '+5 T·∫•n C√¥ng c∆° b·∫£n', baseCost: 50, type: 'atk_flat', val: 5 },
    { id: 'crit_chance', name: 'B√≠ K√≠p Ch√≠ M·∫°ng', desc: '+2% T·ªâ l·ªá Ch√≠ M·∫°ng', baseCost: 800, type: 'crit_chance', val: 0.02 },
    { id: 'crit_dmg', name: 'B√≠ K√≠p Ph√° Gi√°p', desc: '+0.1x S√°t th∆∞∆°ng Ch√≠ M·∫°ng', baseCost: 1500, type: 'crit_dmg', val: 0.1 },
    { id: 'heavy_blade', name: 'Tr·ªçng Ki·∫øm', desc: '+25 T·∫•n C√¥ng c∆° b·∫£n', baseCost: 5000, type: 'atk_flat', val: 25 },
    { id: 'bloody_blade', name: 'Huy·∫øt Ki·∫øm', desc: '+1% H√∫t M√°u', baseCost: 1500, type: 'lifesteal_flat', val: 0.01 }, 
    { id: 'skill_amp', name: 'Ng·ªçc C∆∞·ªùng H√≥a', desc: '+2% Hi·ªáu qu·∫£ K·ªπ NƒÉng', baseCost: 4000, type: 'skill_amp', val: 0.02 },

    // --- SPEED (Original) ---
    { id: 'boots', name: 'Phong L√¥i B·ªô', desc: '+5% T·ªëc ƒë·ªô ƒë√°nh', baseCost: 500, type: 'spd_mult', val: 0.05 },
    { id: 'glove', name: 'H·ªô Uy·ªÉn C∆∞·ªùng H√≥a', desc: '+10% T·ªëc ƒë·ªô ƒë√°nh', baseCost: 3000, type: 'spd_mult', val: 0.1 },
    { id: 'swift_art', name: 'Th·∫ßn T·ªëc Thu·∫≠t', desc: '+20% T·ªëc ƒë·ªô ƒë√°nh', baseCost: 25000, type: 'spd_mult', val: 0.2 },

    // --- DEFENSE (Original) ---
    { id: 'shield', name: 'Linh Thu·∫´n Ph√π', desc: '+20 Khi√™n T·ªëi ƒêa', baseCost: 100, type: 'shield_flat', val: 20 },
    { id: 'mantra', name: 'Thanh T√¢m Ch√∫', desc: '+5 H·ªìi Khi√™n/s', baseCost: 300, type: 'regen_flat', val: 5 },
    { id: 'fortification', name: 'Tr·∫≠n Ph√°p Ph√≤ng Ng·ª±', desc: '+10% Khi√™n T·ªëi ƒêa', baseCost: 8000, type: 'shield_mult', val: 0.1 },
    { id: 'shadow_cloak', name: '√Åm ·∫¢nh B√†o', desc: '+1% N√© Tr√°nh', baseCost: 2500, type: 'evasion_flat', val: 0.01 },
    { id: 'stun_reduc', name: 'ƒêan D∆∞·ª£c Kh√°ng T√¢m', desc: 'Gi·∫£m 5% hi·ªáu ·ª©ng Stun', baseCost: 12000, type: 'stun_mult', val: 0.05 },
    { id: 'spike_armor', name: 'Gi√°p Gai', desc: '+2% Ph·∫£n ƒê√≤n', baseCost: 5000, type: 'reflect_flat', val: 0.02 },

    // --- UTILITY & REALM (Original) ---
    { id: 'ring', name: 'V√≤ng May M·∫Øn', desc: '+2% T·ªâ l·ªá Boss', baseCost: 2000, type: 'boss_chance', val: 0.02 },
    { id: 'skill_mastery', name: 'T√¢m Ph√°p K·ªπ NƒÉng', desc: 'Gi·∫£m 5% CD K·ªπ nƒÉng', baseCost: 15000, type: 'skill_cd_mult', val: 0.05 },
    { id: 'realm_exp', name: 'Kinh Th∆∞ C·∫£nh Gi·ªõi', desc: '+5% EXP Realm c∆° b·∫£n', baseCost: 30000, type: 'realm_exp_mult', val: 0.05 },
    
    // --- NEW ITEMS v5.0 (20 items) ---
    
    // HP Regen Items
    { id: 'hp_regen1', name: 'H·ªìi Nguy√™n ƒêan', desc: '+0.5 H·ªìi M√°u/s', baseCost: 800, type: 'hp_regen_flat', val: 0.5 },
    { id: 'hp_regen2', name: 'Linh Tuy·ªÅn Th·ªßy', desc: '+1.0 H·ªìi M√°u/s', baseCost: 2500, type: 'hp_regen_flat', val: 1.0 },
    { id: 'hp_regen3', name: 'B·∫•t T·ª≠ Th·∫£o', desc: '+2.0 H·ªìi M√°u/s', baseCost: 8000, type: 'hp_regen_flat', val: 2.0 },
    { id: 'hp_regen_mult', name: 'T√°i Sinh Thu·∫≠t', desc: '+10% Hi·ªáu qu·∫£ H·ªìi M√°u', baseCost: 15000, type: 'hp_regen_mult', val: 0.1 },
    
    // Control Resist Items
    { id: 'control_resist1', name: 'T√¢m Linh H·ªô Ph√π', desc: '+3% Kh√°ng Control', baseCost: 1200, type: 'control_resist_flat', val: 0.03 },
    { id: 'control_resist2', name: 'ƒê·ªãnh Th·∫ßn Ch√¢u', desc: '+5% Kh√°ng Control', baseCost: 4000, type: 'control_resist_flat', val: 0.05 },
    { id: 'control_resist3', name: 'V√¥ T∆∞·ªüng Chi T√¢m', desc: '+8% Kh√°ng Control', baseCost: 12000, type: 'control_resist_flat', val: 0.08 },
    
    // Multihit Items
    { id: 'multihit1', name: 'Ph√¢n Th√¢n H·ªô', desc: '+0.1 S·ªë L·∫ßn ƒê√°nh', baseCost: 5000, type: 'multihit_flat', val: 0.1 },
    { id: 'multihit2', name: '·∫¢nh Ki·∫øm Thu·∫≠t', desc: '+0.2 S·ªë L·∫ßn ƒê√°nh', baseCost: 15000, type: 'multihit_flat', val: 0.2 },
    { id: 'multihit3', name: 'Thi√™n Ki·∫øm Quy·∫øt', desc: '+0.3 S·ªë L·∫ßn ƒê√°nh', baseCost: 40000, type: 'multihit_flat', val: 0.3 },
    
    // Boss Damage Items
    { id: 'boss_dmg1', name: 'Tr·∫£m Y√™u Ki·∫øm', desc: '+5% S√°t Th∆∞∆°ng Boss', baseCost: 3000, type: 'boss_dmg_mult', val: 0.05 },
    { id: 'boss_dmg2', name: 'Di·ªát Ma Ch√πy', desc: '+10% S√°t Th∆∞∆°ng Boss', baseCost: 10000, type: 'boss_dmg_mult', val: 0.1 },
    { id: 'boss_dmg3', name: 'Ph·ª•c Ma Th√°p', desc: '+15% S√°t Th∆∞∆°ng Boss', baseCost: 30000, type: 'boss_dmg_mult', val: 0.15 },
    
    // Special Items
    { id: 'lucky_coin', name: 'ƒê·ªìng Ti·ªÅn May M·∫Øn', desc: '+0.5% T·ªâ l·ªá Item Hi·∫øm', baseCost: 20000, type: 'rare_chance', val: 0.005 },
    { id: 'soul_link', name: 'H·ªìn K·∫øt Gi·ªõi', desc: '+1% EXP khi gi·∫øt Boss', baseCost: 15000, type: 'boss_exp_mult', val: 0.01 },
    { id: 'time_warp', name: 'Th·ªùi Gian Ng∆∞ng ƒê·ªçng', desc: '+2% T·ªëc ƒë·ªô Tu Luy·ªán', baseCost: 25000, type: 'cultivate_speed', val: 0.02 },
    { id: 'realm_heart', name: 'ƒê·∫°o T√¢m', desc: '+3% T·∫•t c·∫£ Ch·ªâ S·ªë', baseCost: 50000, type: 'all_stats_mult', val: 0.03 },
    
    // Ultra Rare Items
    { id: 'immortal_pill', name: 'B·∫•t T·ª≠ ƒêan', desc: '+20 Khi√™n T·ªëi ƒêa & +1 H·ªìi M√°u', baseCost: 75000, type: 'combo_shield_regen', val: [20, 1] },
    { id: 'chaos_treasure', name: 'H·ªón ƒê·ªôn Linh B·∫£o', desc: '+5% T·∫•t c·∫£ Ch·ªâ S·ªë T·∫•n C√¥ng', baseCost: 100000, type: 'all_offense_mult', val: 0.05 },
    { id: 'ancient_furnace', name: 'V·∫°n C·ªï ƒêan L√¥', desc: '+10% T·∫•t c·∫£ Ch·ªâ S·ªë Ph√≤ng Th·ªß', baseCost: 100000, type: 'all_defense_mult', val: 0.1 },
];

/* --- STATE --- */
const defState = {
    realm: 0, stage: 0, exp: 0, stones: 0,
    cultivating: true,
    upgrades: {}, 
    sfxVolume: 100, musicVolume: 50,
    fpsLimit: 60,
    currentMusic: 0,
    musicEnabled: true,
    skills: { strike: { lv: 0 }, haste: { lv: 0 }, cleanse: { lv: 0 }, vortex: { lv: 0 } },
    lastSave: Date.now()
};
SHOP.forEach(i => defState.upgrades[i.id] = 0);

let state = JSON.parse(JSON.stringify(defState));

let stats = {
    expRate: 0, maxExp: 10,
    atk: 1, atkSpd: 1, crit: 0.05, critDmg: 1.5,
    maxShield: 10, shieldRegen: 1, shieldMult: 1,
    stoneMult: 1, bossChance: 0.05,
    atkMult: 1, costMult: 1, 
    skillCDMult: 0, stunMult: 1,
    realmExpMult: 1, bossDamageMult: 1,
    lifesteal: 0, evasion: 0, reflect: 0, skillAmp: 0,
    // New v5.0 stats
    hpRegen: 0, hpRegenMult: 1,
    controlResist: 0,
    multihit: 1,
    bossDmgBonus: 1,
    rareChance: 0,
    bossExpBonus: 1,
    cultivateSpeed: 1,
    allStatsMult: 1,
    allOffenseMult: 1,
    allDefenseMult: 1
};

let combat = {
    enemyHp: 10, enemyMax: 10, enemyAtk: 1, isBoss: false,
    curShield: 10,
    atkTimer: 0, enemyAtkTimer: 0,
    stunTimer: 0,
    skillCD: { strike: 0, haste: 0, cleanse: 0, vortex: 0 },
    skillActive: { haste: 0, vortex: 0 }
};

/* --- ENHANCED AUDIO SYSTEM v5.0 --- */
const audio = {
    audioContext: null,
    sfxVolume: 1,
    musicVolume: 0.5,
    backgroundMusic: null,
    currentMusicIndex: 0,
    isMusicPlaying: false,
    
    // Music tracks - complex compositions
    musicTracks: [
        {
            name: "Thi√™n √Çm",
            notes: [
                // Melody 1
                { freq: 261.63, duration: 0.5, type: 'sine', volume: 0.1 }, // C4
                { freq: 293.66, duration: 0.5, type: 'sine', volume: 0.1 }, // D4
                { freq: 329.63, duration: 0.5, type: 'sine', volume: 0.1 }, // E4
                { freq: 349.23, duration: 0.5, type: 'sine', volume: 0.1 }, // F4
                // Harmony
                { freq: 392.00, duration: 2, type: 'sine', volume: 0.05 }, // G4 (drone)
                // Melody 2
                { freq: 440.00, duration: 0.3, type: 'triangle', volume: 0.08 }, // A4
                { freq: 493.88, duration: 0.3, type: 'triangle', volume: 0.08 }, // B4
                { freq: 523.25, duration: 0.4, type: 'triangle', volume: 0.08 }, // C5
                // Bass
                { freq: 130.81, duration: 1, type: 'sawtooth', volume: 0.03 }, // C3
            ]
        },
        {
            name: "U Minh C·ªï Kh√∫c",
            notes: [
                // Mysterious melody
                { freq: 277.18, duration: 0.8, type: 'sine', volume: 0.1 }, // C#4
                { freq: 311.13, duration: 0.8, type: 'sine', volume: 0.1 }, // D#4
                { freq: 369.99, duration: 0.6, type: 'sine', volume: 0.1 }, // F#4
                { freq: 415.30, duration: 0.6, type: 'sine', volume: 0.1 }, // G#4
                // Dark drone
                { freq: 103.83, duration: 3, type: 'sawtooth', volume: 0.04 }, // G#2
                // Echo effect
                { freq: 554.37, duration: 0.2, type: 'triangle', volume: 0.06 }, // C#5
                { freq: 622.25, duration: 0.2, type: 'triangle', volume: 0.06 }, // D#5
            ]
        },
        {
            name: "ƒê·∫°o T·∫°ng Ch√¢n Kinh",
            notes: [
                // Sacred melody
                { freq: 329.63, duration: 0.5, type: 'sine', volume: 0.12 }, // E4
                { freq: 392.00, duration: 0.5, type: 'sine', volume: 0.12 }, // G4
                { freq: 440.00, duration: 0.5, type: 'sine', volume: 0.12 }, // A4
                { freq: 523.25, duration: 0.5, type: 'sine', volume: 0.12 }, // C5
                // Choir effect
                { freq: 659.25, duration: 1, type: 'sine', volume: 0.06 }, // E5
                { freq: 783.99, duration: 1, type: 'sine', volume: 0.06 }, // G5
                // Bell tones
                { freq: 1046.50, duration: 0.1, type: 'triangle', volume: 0.05 }, // C6
            ]
        }
    ],
    
    // Sound effects
    sounds: {
        hit: { type: 'square', freq: 400, duration: 0.08, volume: 0.3 },
        block: { type: 'sine', freq: 250, duration: 0.15, volume: 0.2 },
        kill: { type: 'sawtooth', freq: 600, duration: 0.15, volume: 0.4, fade: true },
        boss_kill: { 
            type: 'sequence',
            sequence: [
                { type: 'sawtooth', freq: 800, duration: 0.15, volume: 0.3 },
                { type: 'sawtooth', freq: 600, duration: 0.15, volume: 0.3 },
                { type: 'sawtooth', freq: 400, duration: 0.2, volume: 0.4 },
                { type: 'square', freq: 200, duration: 0.3, volume: 0.5 }
            ]
        },
        upgrade: { type: 'sine', freq: 900, duration: 0.2, volume: 0.3, fade: true },
        buy: { type: 'square', freq: 700, duration: 0.1, volume: 0.3 },
        error: { type: 'square', freq: 200, duration: 0.3, volume: 0.2 },
        breakthrough: { 
            type: 'sequence',
            sequence: [
                { type: 'sine', freq: 200, duration: 0.1, volume: 0.3 },
                { type: 'sine', freq: 300, duration: 0.1, volume: 0.3 },
                { type: 'sine', freq: 400, duration: 0.1, volume: 0.3 },
                { type: 'sine', freq: 600, duration: 0.2, volume: 0.4 },
                { type: 'sine', freq: 800, duration: 0.3, volume: 0.5 }
            ]
        },
        stun: { type: 'sine', freq: 120, duration: 0.5, volume: 0.3 },
        meditate_on: { type: 'sine', freq: 550, duration: 0.3, volume: 0.2, fade: true },
        meditate_off: { type: 'sine', freq: 350, duration: 0.3, volume: 0.2, fade: true },
        skill_strike: { type: 'square', freq: 500, duration: 0.15, volume: 0.4 },
        skill_buff: { type: 'sine', freq: 650, duration: 0.25, volume: 0.3, fade: true },
        skill_heal: { type: 'sine', freq: 350, duration: 0.4, volume: 0.3, fade: true },
        skill_defense: { type: 'square', freq: 250, duration: 0.3, volume: 0.3 },
        evade: { type: 'sine', freq: 850, duration: 0.08, volume: 0.2 },
        heal: { type: 'triangle', freq: 300, duration: 0.2, volume: 0.25, fade: true }
    },
    
    init() {
        // Initialize audio context on first user interaction
        document.addEventListener('click', () => {
            if (!this.audioContext) {
                this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                console.log('Audio context initialized');
                this.startBackgroundMusic();
            }
        }, { once: true });
        
        // Set initial volumes from state
        this.sfxVolume = state.sfxVolume / 100;
        this.musicVolume = state.musicVolume / 100;
        this.currentMusicIndex = state.currentMusic;
        
        // Setup music toggle button
        document.getElementById('music-toggle').addEventListener('click', () => this.toggleMusic());
        document.getElementById('music-select').addEventListener('change', (e) => this.changeMusic(parseInt(e.target.value)));
        
        // Update music title
        this.updateMusicUI();
    },
    
    startBackgroundMusic() {
        if (!this.audioContext || !state.musicEnabled) return;
        
        this.isMusicPlaying = true;
        this.playMusicTrack(this.currentMusicIndex);
    },
    
    playMusicTrack(trackIndex) {
        if (!this.audioContext || !state.musicEnabled) return;
        
        const track = this.musicTracks[trackIndex];
        if (!track) return;
        
        // Stop current music
        if (this.backgroundMusic) {
            this.backgroundMusic.forEach(node => {
                if (node.oscillator) node.oscillator.stop();
            });
        }
        
        this.backgroundMusic = [];
        this.currentMusicIndex = trackIndex;
        state.currentMusic = trackIndex;
        
        // Play all notes in the track with timing
        track.notes.forEach((note, index) => {
            const startTime = this.audioContext.currentTime + (index * note.duration * 0.8);
            
            const oscillator = this.audioContext.createOscillator();
            const gainNode = this.audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(this.audioContext.destination);
            
            oscillator.type = note.type;
            oscillator.frequency.value = note.freq;
            
            const volume = note.volume * this.musicVolume;
            gainNode.gain.setValueAtTime(volume, startTime);
            
            if (note.fade) {
                gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + note.duration);
            } else {
                gainNode.gain.linearRampToValueAtTime(0, startTime + note.duration);
            }
            
            oscillator.start(startTime);
            oscillator.stop(startTime + note.duration);
            
            this.backgroundMusic.push({ oscillator, gain: gainNode });
        });
        
        // Loop the track
        setTimeout(() => {
            if (this.isMusicPlaying) {
                this.playMusicTrack(trackIndex);
            }
        }, track.notes.length * 500);
        
        this.updateMusicUI();
    },
    
    toggleMusic() {
        if (!this.audioContext) {
            // Try to initialize on click
            this.audioContext = new (window.AudioContext || window.webkitAudioContext)();
            this.startBackgroundMusic();
            return;
        }
        
        state.musicEnabled = !state.musicEnabled;
        
        if (state.musicEnabled) {
            this.isMusicPlaying = true;
            this.startBackgroundMusic();
            document.getElementById('music-toggle').textContent = '‚è∏Ô∏è';
        } else {
            this.isMusicPlaying = false;
            if (this.backgroundMusic) {
                this.backgroundMusic.forEach(node => {
                    if (node.oscillator) node.oscillator.stop();
                });
            }
            document.getElementById('music-toggle').textContent = '‚ñ∂Ô∏è';
        }
    },
    
    changeMusic(index) {
        if (index >= 0 && index < this.musicTracks.length) {
            this.currentMusicIndex = index;
            state.currentMusic = index;
            if (this.isMusicPlaying && this.audioContext) {
                this.playMusicTrack(index);
            }
        }
    },
    
    updateMusicUI() {
        const track = this.musicTracks[this.currentMusicIndex];
        if (track) {
            document.getElementById('music-title').textContent = `Nh·∫°c: ${track.name}`;
        }
    },
    
    setVolume(type, value) {
        if (type === 'sfx') {
            this.sfxVolume = value / 100;
            state.sfxVolume = value;
        } else if (type === 'music') {
            this.musicVolume = value / 100;
            state.musicVolume = value;
        }
    },
    
    playSFX(soundName) {
        if (!this.audioContext || this.sfxVolume <= 0) return;
        
        const sound = this.sounds[soundName];
        if (!sound) return;
        
        if (sound.type === 'sequence') {
            // Play sequence of sounds
            sound.sequence.forEach((note, index) => {
                setTimeout(() => {
                    this.playNote(note);
                }, index * 100);
            });
        } else {
            // Play single sound
            this.playNote(sound);
        }
    },
    
    playNote(note) {
        if (!this.audioContext || this.sfxVolume <= 0) return;
        
        try {
            const oscillator = this.audioContext.createOscillator();
            const gainNode = this.audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(this.audioContext.destination);
            
            oscillator.type = note.type;
            oscillator.frequency.value = note.freq;
            
            const now = this.audioContext.currentTime;
            const volume = note.volume * this.sfxVolume;
            gainNode.gain.setValueAtTime(volume, now);
            
            if (note.fade) {
                gainNode.gain.exponentialRampToValueAtTime(0.001, now + note.duration);
            } else {
                gainNode.gain.linearRampToValueAtTime(0, now + note.duration);
            }
            
            oscillator.start(now);
            oscillator.stop(now + note.duration);
        } catch (e) {
            console.log('Sound play failed:', e);
        }
    }
};

/* --- CORE LOGIC --- */
const game = {
    loopId: null,
    lastTime: Date.now(),
    frameCount: 0,
    lastFpsTime: Date.now(),
    totalHits: 0,
    totalKills: 0,
    totalBossKills: 0,
    totalStonesEarned: 0,

    init() {
        this.load();
        this.recalc();
        this.spawnEnemy();
        ui.initShop();
        ui.update();
        audio.init(); 
        
        // Setup FPS settings
        document.getElementById('fps-select').value = state.fpsLimit;
        document.getElementById('music-select').value = state.currentMusic;
        document.getElementById('sfx-volume').value = state.sfxVolume;
        document.getElementById('music-volume').value = state.musicVolume;

        this.lastTime = Date.now();
        this.loopId = requestAnimationFrame(() => this.tick());
        setInterval(() => this.save(), 30000);
        
        // Auto-start background music after a short delay
        setTimeout(() => {
            if (!audio.audioContext && state.musicEnabled) {
                audio.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                audio.startBackgroundMusic();
            }
        }, 1000);
    },

    setFPS(val) {
        state.fpsLimit = parseInt(val);
        ui.log(`ƒê√£ ƒë·∫∑t gi·ªõi h·∫°n FPS: ${state.fpsLimit === 0 ? "V√¥ h·∫°n" : state.fpsLimit}`, "norm");
    },

    tick() {
        const now = Date.now();
        const elapsed = now - this.lastTime;
        
        // FPS Throttling
        if (state.fpsLimit > 0 && elapsed < (1000 / state.fpsLimit)) {
            this.loopId = requestAnimationFrame(() => this.tick());
            return;
        }

        const dt = elapsed / 1000;
        this.lastTime = now;

        // FPS Counter
        this.frameCount++;
        if (now - this.lastFpsTime >= 1000) {
            document.getElementById('fps-display').innerText = `FPS: ${this.frameCount}`;
            this.frameCount = 0;
            this.lastFpsTime = now;
        }

        // Logic
        this.updateCultivation(dt);
        this.updateCooldowns(dt);
        this.updateRegen(dt);
        this.updateCombat(dt);
        this.updateHpRegen(dt);

        ui.renderFrame(dt);
        this.loopId = requestAnimationFrame(() => this.tick());
    },

    updateCultivation(dt) {
        if (state.cultivating && combat.stunTimer <= 0) {
            const effectiveRate = stats.expRate * stats.cultivateSpeed;
            state.exp += effectiveRate * dt;
            if (state.exp > stats.maxExp) state.exp = stats.maxExp;
        }
    },

    updateCooldowns(dt) {
        if (combat.stunTimer > 0) combat.stunTimer -= dt * (1 + stats.controlResist);
        
        // Skill Cooldowns
        for (let k in combat.skillCD) {
            if (combat.skillCD[k] > 0) combat.skillCD[k] -= dt * (1 + stats.skillCDMult);
        }
        
        // Active Buffs
        let needsRecalc = false;
        for (let k in combat.skillActive) {
            if (combat.skillActive[k] > 0) {
                combat.skillActive[k] -= dt;
                if (combat.skillActive[k] <= 0) needsRecalc = true;
            }
        }
        if (needsRecalc) this.recalc();
    },

    updateRegen(dt) {
        if (combat.stunTimer <= 0 && combat.curShield < stats.maxShield) {
            combat.curShield += stats.shieldRegen * dt;
            if (combat.curShield > stats.maxShield) combat.curShield = stats.maxShield;
        }
    },

    updateHpRegen(dt) {
        if (combat.stunTimer <= 0 && combat.curShield < stats.maxShield) {
            const effectiveRegen = stats.hpRegen * stats.hpRegenMult;
            combat.curShield += effectiveRegen * dt;
            if (combat.curShield > stats.maxShield) combat.curShield = stats.maxShield;
        }
    },

    updateCombat(dt) {
        if (combat.stunTimer > 0) return;

        // Player Hit
        combat.atkTimer += dt;
        if (combat.atkTimer >= (1.5 / stats.atkSpd)) {
            combat.atkTimer = 0;
            this.attackEnemy();
        }

        // Enemy Hit
        if (combat.enemyHp > 0) {
            combat.enemyAtkTimer += dt;
            if (combat.enemyAtkTimer >= 2.0) {
                combat.enemyAtkTimer = 0;
                this.enemyHitsPlayer();
            }
        }
    },

    recalc() {
        const r = REALMS[state.realm];
        
        // Reset Stats
        stats.shieldMult = 1; stats.atkMult = 1; stats.critDmg = 1.5; stats.stoneMult = 1; 
        stats.costMult = 1; stats.skillCDMult = 0; stats.stunMult = 1;
        stats.realmExpMult = 1; stats.bossDamageMult = 1;
        stats.lifesteal = 0; stats.evasion = 0; stats.reflect = 0; stats.skillAmp = 0;
        
        // New v5.0 stats
        stats.hpRegen = 0; stats.hpRegenMult = 1;
        stats.controlResist = 0;
        stats.multihit = 1;
        stats.bossDmgBonus = 1;
        stats.rareChance = 0;
        stats.bossExpBonus = 1;
        stats.cultivateSpeed = 1;
        stats.allStatsMult = 1;
        stats.allOffenseMult = 1;
        stats.allDefenseMult = 1;
        
        // Base Stats from Realm
        let flatExp = 5 + (state.realm * 10);
        let flatAtk = 1 + (state.realm * 5);
        let flatShield = 10 + (state.realm * 20);
        
        let baseCrit = 0.05;
        let baseBossChance = 0.05;
        let baseSpdMult = 1;

        // Apply Upgrades
        SHOP.forEach(item => {
            const lv = state.upgrades[item.id];
            if (lv > 0) {
                const val = item.val * lv;
                switch (item.type) {
                    case 'exp_flat': flatExp += val; break;
                    case 'exp_mult': stats.expMult = (stats.expMult || 1) + val; break;
                    case 'atk_flat': flatAtk += val; break;
                    case 'shield_flat': flatShield += val; break;
                    case 'shield_mult': stats.shieldMult += val; break;
                    case 'regen_flat': stats.shieldRegen = (stats.shieldRegen || 1) + val; break;
                    case 'spd_mult': baseSpdMult += val; break;
                    case 'crit_chance': baseCrit += val; break;
                    case 'crit_dmg': stats.critDmg += val; break;
                    case 'lifesteal_flat': stats.lifesteal += val; break;
                    case 'evasion_flat': stats.evasion += val; break;
                    case 'reflect_flat': stats.reflect += val; break;
                    case 'skill_amp': stats.skillAmp += val; break;
                    case 'stun_mult': stats.stunMult *= (1 - item.val * lv); break;
                    case 'stone_mult': stats.stoneMult += val; break;
                    case 'boss_chance': baseBossChance += val; break;
                    case 'skill_cd_mult': stats.skillCDMult += val; break;
                    case 'realm_exp_mult': stats.realmExpMult += val; break;
                    
                    // New v5.0 types
                    case 'hp_regen_flat': stats.hpRegen += val; break;
                    case 'hp_regen_mult': stats.hpRegenMult += val; break;
                    case 'control_resist_flat': stats.controlResist += val; break;
                    case 'multihit_flat': stats.multihit += val; break;
                    case 'boss_dmg_mult': stats.bossDmgBonus += val; break;
                    case 'rare_chance': stats.rareChance += val; break;
                    case 'boss_exp_mult': stats.bossExpBonus += val; break;
                    case 'cultivate_speed': stats.cultivateSpeed += val; break;
                    case 'all_stats_mult': stats.allStatsMult += val; break;
                    case 'all_offense_mult': stats.allOffenseMult += val; break;
                    case 'all_defense_mult': stats.allDefenseMult += val; break;
                    case 'combo_shield_regen': 
                        flatShield += item.val[0] * lv;
                        stats.hpRegen += item.val[1] * lv;
                        break;
                }
            }
        });
        
        // Apply global multipliers
        flatExp *= stats.realmExpMult * stats.allStatsMult;
        flatAtk *= stats.allStatsMult * stats.allOffenseMult;
        flatShield *= stats.allStatsMult * stats.allDefenseMult;
        baseCrit *= stats.allStatsMult * stats.allOffenseMult;
        stats.hpRegen *= stats.hpRegenMult * stats.allStatsMult * stats.allDefenseMult;
        stats.controlResist *= stats.allStatsMult * stats.allDefenseMult;
        
        // Apply Final Calcs
        stats.expRate = flatExp * (stats.expMult || 1);
        stats.maxExp = (r.exp / r.stages) * (1 + state.stage * 0.1); 
        stats.atk = flatAtk * stats.atkMult;
        
        // Haste Skill
        if (combat.skillActive.haste > 0) {
             let hasteBonus = 0.5 + (state.skills.haste.lv * 0.1 * (1 + stats.skillAmp));
             baseSpdMult += hasteBonus;
        }

        stats.atkSpd = baseSpdMult;
        stats.maxShield = flatShield * stats.shieldMult;
        stats.crit = Math.min(1.0, baseCrit);
        stats.bossChance = baseBossChance;
        stats.bossDamageMult = stats.bossDmgBonus;

        if (combat.curShield > stats.maxShield) combat.curShield = stats.maxShield;
    },

    spawnEnemy() {
        combat.isBoss = Math.random() < stats.bossChance;
        let baseHp = 20 * Math.pow(1.5, state.realm) * (1 + state.stage * 0.2);
        let baseDmg = stats.maxShield * 0.15; 

        if (combat.isBoss) {
            combat.enemyMax = baseHp * 10;
            combat.enemyAtk = baseDmg * 2;
            ui.log("Ma V∆∞∆°ng xu·∫•t hi·ªán!", "boss");
        } else {
            combat.enemyMax = baseHp;
            combat.enemyAtk = baseDmg;
        }
        
        // Scale Enemy Dmg
        combat.enemyAtk = Math.max(1, combat.enemyAtk + state.realm * 0.5 + state.stage * 0.1); 
        combat.enemyHp = combat.enemyMax;
        combat.enemyAtkTimer = 0;
        
        ui.updateSprite(combat.isBoss);
        ui.updateEnemyStats();
    },

    attackEnemy() {
        audio.playSFX('hit');
        ui.animPlayerAtk();
        
        // Multihit mechanic
        const hits = Math.floor(stats.multihit) + (Math.random() < (stats.multihit % 1) ? 1 : 0);
        let totalDmg = 0;
        
        for (let i = 0; i < hits; i++) {
            let isCrit = Math.random() < stats.crit;
            let dmg = stats.atk * (isCrit ? stats.critDmg : 1);
            if (combat.isBoss) dmg *= stats.bossDamageMult;
            
            totalDmg += dmg;
            
            // Display individual hit for multihit > 1
            if (hits > 1 && i === hits - 1) {
                ui.floatText(`${ui.fmt(dmg)}`, "enemy", isCrit ? "var(--crit-color)" : "#fff", isCrit);
            }
        }
        
        combat.enemyHp -= totalDmg;
        this.totalHits++;
        
        // Display total damage if multihit
        if (hits > 1) {
            ui.floatText(`${hits}x ${ui.fmt(totalDmg)}`, "enemy", "#b388ff");
        } else {
            ui.floatText(ui.fmt(totalDmg) + (stats.crit > Math.random() ? "!" : ""), "enemy", "var(--crit-color)", true);
        }

        // Lifesteal
        if (stats.lifesteal > 0) {
            const lifeHeal = totalDmg * stats.lifesteal;
            combat.curShield = Math.min(stats.maxShield, combat.curShield + lifeHeal);
            if (lifeHeal > 0.5) {
                ui.floatText(`+${ui.fmt(lifeHeal)}`, "player", "#e57373");
                audio.playSFX('heal');
            }
        }

        if (combat.enemyHp <= 0) this.killEnemy();
    },

    enemyHitsPlayer() {
        // Evasion
        if (Math.random() < stats.evasion) {
            audio.playSFX('evade');
            ui.floatText("N√â!", "player", "#00ff00", false, true);
            return;
        }

        audio.playSFX('block');
        ui.animEnemyAtk();
        
        let dmg = combat.enemyAtk;
        
        // Vortex Skill Mitigation
        if (combat.skillActive.vortex > 0) {
            let reduction = 0.5 + (state.skills.vortex.lv * 0.05 * (1 + stats.skillAmp));
            dmg *= (1 - Math.min(0.9, reduction));
        }

        // Reflect Logic
        if (stats.reflect > 0) {
            let refDmg = dmg * stats.reflect;
            combat.enemyHp -= refDmg;
            ui.floatText(`Ph·∫£n ${ui.fmt(refDmg)}`, "enemy", "#ff9800");
            if (combat.enemyHp <= 0) this.killEnemy();
        }

        if (combat.curShield >= dmg) {
            combat.curShield -= dmg;
            ui.floatText("Ch·∫∑n", "player", "#64b5f6");
        } else {
            combat.curShield = 0;
            // Shield Break with control resist
            let stunTime = 3.0 * stats.stunMult * (1 - stats.controlResist); 
            combat.stunTimer = Math.max(0.5, stunTime);
            
            ui.log(`Khi√™n v·ª°! Cho√°ng ${combat.stunTimer.toFixed(1)}s!`, "warn");
            ui.floatText("B·∫§T ƒê·ªòNG", "player", "#e53935");
            
            // Change player sprite to hurt state
            const playerSprite = document.getElementById('player');
            playerSprite.classList.add('hurt');
            playerSprite.classList.add('anim-stun');
            
            setTimeout(() => {
                playerSprite.classList.remove('anim-stun');
                setTimeout(() => playerSprite.classList.remove('hurt'), 500);
            }, combat.stunTimer * 1000);
            
            audio.playSFX('stun');
        }
    },

    killEnemy() {
        audio.playSFX(combat.isBoss ? 'boss_kill' : 'kill');
        let loot = (1 + state.realm) * (1 + state.stage);
        if (combat.isBoss) {
            loot *= 15;
            this.totalBossKills++;
            loot *= stats.bossExpBonus;
        } else {
            this.totalKills++;
        }
        
        // Rare item chance
        if (stats.rareChance > 0 && Math.random() < stats.rareChance) {
            loot *= 2;
            ui.floatText("HI·∫æM!", "player", "#b388ff");
        }
        
        loot = Math.floor(loot * stats.stoneMult);
        state.stones += loot;
        this.totalStonesEarned += loot;
        
        // Experience gain with boss bonus
        let expGain = stats.expRate * 0.5;
        if (combat.isBoss) expGain *= stats.bossExpBonus;
        state.exp += expGain;

        ui.floatText(`+${ui.fmt(loot)} LT`, "player", "#ffd700");
        this.spawnEnemy();
    },

    activateSkill(id) {
        if (combat.skillCD[id] > 0 || combat.stunTimer > 0) return;

        let lv = state.skills[id].lv;
        let amp = 1 + stats.skillAmp;
        
        if (id === 'strike') {
            audio.playSFX('skill_strike');
            let dmg = stats.atk * (5 + lv * 2) * amp;
            let shieldDmg = combat.enemyHp * 0.5; // True Dmg
            
            combat.enemyHp -= (dmg + shieldDmg);
            ui.floatText(ui.fmt(dmg + shieldDmg), "enemy", "#b388ff");
            
            // Change player sprite to hitting state
            const playerSprite = document.getElementById('player');
            playerSprite.classList.add('hitting');
            setTimeout(() => playerSprite.classList.remove('hitting'), 300);
            
            if (combat.enemyHp <= 0) this.killEnemy();
            combat.skillCD.strike = 10 * (1 - stats.skillCDMult); 
        }
        if (id === 'haste') {
            audio.playSFX('skill_buff');
            combat.skillActive.haste = (5 + (lv * 0.5)) * amp;
            combat.skillCD.haste = 20 * (1 - stats.skillCDMult);
            this.recalc();
            ui.floatText("GIA T·ªêC", "player", "#fff");
        }
        if (id === 'cleanse') {
            audio.playSFX('skill_heal');
            let healPct = (0.3 + (lv * 0.05)) * amp;
            let healAmount = stats.maxShield * healPct;
            combat.curShield = Math.min(stats.maxShield, combat.curShield + healAmount);
            ui.floatText(`+${ui.fmt(healAmount)} Khi√™n`, "player", "#00ffff");
            audio.playSFX('heal');
            combat.skillCD.cleanse = 30 * (1 - stats.skillCDMult);
        }
        if (id === 'vortex') {
            audio.playSFX('skill_defense');
            combat.skillActive.vortex = (4 + (lv * 0.5)) * amp;
            combat.skillCD.vortex = 45 * (1 - stats.skillCDMult);
            this.recalc();
            ui.floatText("KIM CANG", "player", "#ffd700");
        }
    },

    upgradeSkill(id) {
        let lv = state.skills[id].lv;
        let baseCost = { strike: 100, haste: 200, cleanse: 500, vortex: 1000 }[id];
        let cost = Math.floor(baseCost * Math.pow(2.5, lv) * stats.costMult);
        
        if (state.stones >= cost) {
            audio.playSFX('upgrade');
            state.stones -= cost;
            state.skills[id].lv++;
            this.recalc();
            ui.update();
        } else {
            audio.playSFX('error');
        }
    },

    buy(id) {
        let item = SHOP.find(x=>x.id == id);
        let cost = Math.floor(item.baseCost * Math.pow(1.5, state.upgrades[id]) * stats.costMult);
        if (state.stones >= cost) {
            audio.playSFX('buy');
            state.stones -= cost;
            state.upgrades[id]++;
            this.recalc();
            ui.updateShop();
            ui.update();
        } else {
            audio.playSFX('error');
        }
    },

    breakthrough() {
        if (state.exp < stats.maxExp) return;
        audio.playSFX('breakthrough');
        let r = REALMS[state.realm];
        state.stage++;
        state.exp = 0;
        combat.curShield = stats.maxShield;
        
        if (state.stage >= r.stages) {
            if (state.realm < REALMS.length - 1) {
                state.realm++; state.stage = 0;
                ui.log(`ƒê·ªôt ph√° th√†nh c√¥ng: ${REALMS[state.realm].name}!`, "boss");
            } else { state.stage--; }
        } else {
            ui.log(`ƒê·∫°t t·ªõi Giai ƒêo·∫°n ${state.stage+1}`, "norm");
        }
        this.recalc(); this.spawnEnemy(); this.save(); ui.update();
    },

    toggleCultivate() { 
        state.cultivating = !state.cultivating; 
        audio.playSFX(state.cultivating ? 'meditate_on' : 'meditate_off');
        ui.update(); 
    },

    save(manual) {
        state.sfxVolume = document.getElementById('sfx-volume').value;
        state.musicVolume = document.getElementById('music-volume').value;
        state.fpsLimit = parseInt(document.getElementById('fps-select').value);
        state.currentMusic = parseInt(document.getElementById('music-select').value);
        localStorage.setItem('daoist_v5', JSON.stringify(state));
        ui.log("Game ƒë√£ ƒë∆∞·ª£c l∆∞u.", "norm");
        if (manual) alert("ƒê√£ l∆∞u th√†nh c√¥ng!");
    },
    
    load() {
        let s = localStorage.getItem('daoist_v5');
        if (s) {
            let loaded = JSON.parse(s);
            state = { ...defState, ...loaded, upgrades: { ...defState.upgrades, ...loaded.upgrades }, skills: { ...defState.skills, ...loaded.skills } };
            ui.log(`T·∫£i game th√†nh c√¥ng.`, "accent");
        }
    },
    
    hardReset() {
        if(confirm("X√≥a to√†n b·ªô ti·∫øn tr√¨nh?")) { 
            localStorage.removeItem('daoist_v5'); 
            location.reload(); 
        }
    },
    
    exportSave() { 
        this.save(); 
        navigator.clipboard.writeText(btoa(JSON.stringify(state))); 
        alert("ƒê√£ copy Save!"); 
    },
    
    importSave() {
        let str = prompt("D√°n Save:");
        if (str) { 
            try { 
                localStorage.setItem('daoist_v5', atob(str)); 
                location.reload(); 
            } catch(e) { 
                alert("L·ªói save."); 
            } 
        }
    }
};

/* --- UI --- */
const ui = {
    fmt: (n) => {
        if (n >= 1e12) return (n/1e12).toFixed(2)+"T";
        if (n >= 1e9) return (n/1e9).toFixed(2)+"B";
        if (n >= 1e6) return (n/1e6).toFixed(2)+"M";
        if (n >= 1e3) return (n/1e3).toFixed(1)+"k";
        return Math.floor(n);
    },
    
    initShop() {
        const c = document.getElementById('tab-shop'); 
        c.innerHTML = "<div style='text-align:center; color:#aaa; margin:10px 0;'>Ch·ªçn v·∫≠t ph·∫©m ƒë·ªÉ mua</div>";
        
        // Group items by category
        const categories = {
            'exp': SHOP.filter(item => item.type.includes('exp') || item.type.includes('realm')),
            'offense': SHOP.filter(item => item.type.includes('atk') || item.type.includes('crit') || item.type.includes('lifesteal') || item.type.includes('skill_amp') || item.type.includes('multihit') || item.type.includes('boss_dmg')),
            'defense': SHOP.filter(item => item.type.includes('shield') || item.type.includes('regen') || item.type.includes('evasion') || item.type.includes('reflect') || item.type.includes('hp_regen') || item.type.includes('control_resist')),
            'utility': SHOP.filter(item => item.type.includes('spd') || item.type.includes('stone') || item.type.includes('boss_chance') || item.type.includes('skill_cd') || item.type.includes('rare') || item.type.includes('cultivate') || item.type.includes('all_'))
        };
        
        // Create shop sections
        for (const [catName, items] of Object.entries(categories)) {
            if (items.length > 0) {
                let section = document.createElement('div');
                section.innerHTML = `<div style="color:#64b5f6; font-weight:bold; margin:15px 0 10px 0; border-bottom:1px solid rgba(100,181,246,0.3); padding-bottom:5px;">${this.getCategoryName(catName)}</div>`;
                c.appendChild(section);
                
                items.forEach(item => {
                    let div = document.createElement('div');
                    div.className = 'shop-item';
                    div.innerHTML = `
                        <div>
                            <div style="font-weight:bold; color:#fff">${item.name}</div>
                            <div style="font-size:0.85em; color:#aaa; margin-top:3px;">${item.desc}</div>
                            <div style="font-size:0.75em; color:#888; margin-top:2px;">Hi·ªán c√≥: Lv ${state.upgrades[item.id]}</div>
                        </div>
                        <button class="btn btn-blue" id="buy-${item.id}" style="font-size:0.85rem; padding:8px 15px;">Mua</button>`;
                    div.querySelector('button').onclick = () => game.buy(item.id);
                    c.appendChild(div);
                });
            }
        }
        this.updateShop();
    },
    
    getCategoryName(cat) {
        const names = {
            'exp': 'üìà EXP & T√ÄI NGUY√äN',
            'offense': '‚öîÔ∏è T·∫§N C√îNG',
            'defense': 'üõ°Ô∏è PH√íNG TH·ª¶',
            'utility': 'üîÆ TI·ªÜN √çCH'
        };
        return names[cat] || cat.toUpperCase();
    },

    updateShop() {
        SHOP.forEach(item => {
            let cost = Math.floor(item.baseCost * Math.pow(1.5, state.upgrades[item.id]) * stats.costMult);
            let btn = document.getElementById(`buy-${item.id}`);
            if (btn) {
                btn.innerText = `${ui.fmt(cost)} LT`;
                btn.disabled = state.stones < cost;
                btn.title = `Lv ${state.upgrades[item.id]}`;
            }
        });
    },

    update() {
        // Realm info
        document.getElementById('realm-name').innerText = REALMS[state.realm].name;
        document.getElementById('stage-name').innerText = `Giai ƒêo·∫°n ${state.stage + 1}`;
        
        // Stats display
        document.getElementById('val-rate').innerText = this.fmt(stats.expRate) + "/s";
        document.getElementById('val-stones').innerText = this.fmt(state.stones);
        document.getElementById('val-atk').innerText = this.fmt(stats.atk);
        document.getElementById('val-shield').innerText = this.fmt(stats.maxShield);
        document.getElementById('val-spd').innerText = (1.5/stats.atkSpd).toFixed(2) + "s";
        document.getElementById('val-crit').innerText = (stats.crit * 100).toFixed(1) + "%";
        document.getElementById('val-lifesteal').innerText = (stats.lifesteal * 100).toFixed(1) + "%";
        document.getElementById('val-evasion').innerText = (stats.evasion * 100).toFixed(1) + "%";
        document.getElementById('val-reflect').innerText = (stats.reflect * 100).toFixed(1) + "%";
        document.getElementById('val-hp-regen').innerText = this.fmt(stats.hpRegen * stats.hpRegenMult) + "/s";
        document.getElementById('val-control-resist').innerText = (stats.controlResist * 100).toFixed(1) + "%";
        document.getElementById('val-boss-dmg').innerText = (stats.bossDamageMult * 100).toFixed(0) + "%";
        document.getElementById('val-multihit').innerText = stats.multihit.toFixed(1);

        // Cultivate button
        const bCult = document.getElementById('btn-cultivate');
        bCult.innerText = state.cultivating ? "TU LUY·ªÜN: B·∫¨T" : "TU LUY·ªÜN: T·∫ÆT";
        bCult.style.background = state.cultivating ? "linear-gradient(135deg, #2e7d32, #1b5e20)" : "rgba(42,42,62,0.8)";

        // Breakthrough button
        const bBreak = document.getElementById('btn-break');
        if (state.exp >= stats.maxExp) {
            bBreak.disabled = false; 
            bBreak.innerText = "ƒê·ªòT PH√Å!"; 
            bBreak.classList.add('btn-gold');
        } else {
            bBreak.disabled = true; 
            bBreak.innerText = `${this.fmt(state.exp)}/${this.fmt(stats.maxExp)}`; 
            bBreak.classList.remove('btn-gold');
        }
        
        // Skill Labels
        ['strike','haste','cleanse','vortex'].forEach(id => {
            let lv = state.skills[id].lv;
            let base = { strike: 100, haste: 200, cleanse: 500, vortex: 1000 }[id];
            let cost = Math.floor(base * Math.pow(2.5, lv) * stats.costMult);
            document.getElementById(`cost-${id}`).innerText = this.fmt(cost);
            let name = { strike:'L√¥i Ch∆∞·ªüng', haste:'Gia T·ªëc', cleanse:'Thanh T√¢m', vortex:'Kim Cang' }[id];
            document.getElementById(`label-${id}`).innerText = `${name} (Lv ${lv})`;
            
            // Update skill icon readiness
            const icon = document.querySelector(`#label-${id}`).parentElement;
            if (combat.skillCD[id] <= 0) {
                icon.classList.add('ready');
            } else {
                icon.classList.remove('ready');
            }
        });

        this.updateShop();
        this.updateDetailModal();
    },

    renderFrame(dt) {
        // Bars
        document.getElementById('exp-bar').style.width = ((state.exp / stats.maxExp) * 100) + "%";
        document.getElementById('exp-text').innerText = `${this.fmt(state.exp)} / ${this.fmt(stats.maxExp)} EXP`;
        document.getElementById('v-hp-bar').style.width = Math.max(0, (combat.enemyHp / combat.enemyMax) * 100) + "%";
        document.getElementById('v-shield-bar').style.width = Math.max(0, (combat.curShield / stats.maxShield) * 100) + "%";

        // Skill cooldowns
        ['strike','haste','cleanse','vortex'].forEach(id => {
            let max = { strike: 10, haste: 20, cleanse: 30, vortex: 45 }[id];
            let current = Math.max(0, combat.skillCD[id]);
            document.getElementById(`cd-${id}`).style.height = (current/max)*100 + "%";
        });

        // Periodic update
        if (Math.random() < 0.05) this.update();
        this.updateEnemyStats();
    },
    
    updateEnemyStats() {
        const eStats = document.getElementById('enemy-stats-text');
        const enemyType = combat.isBoss ? '<span class="boss-text">BOSS Ma V∆∞∆°ng</span>' : 'Qu√°i Th∆∞·ªùng';
        const hpText = `${this.fmt(combat.enemyHp)} / ${this.fmt(combat.enemyMax)}`;
        const dmgText = `${this.fmt(combat.enemyAtk)}`;
        
        eStats.innerHTML = `
            <div>${enemyType}</div>
            <div>HP: ${hpText}</div>
            <div>DMG: ${dmgText}</div>
            <div style="margin-top:5px; color:#aaa; font-size:0.75em;">X√°c su·∫•t t·∫•n c√¥ng: 2s/l·∫ßn</div>
        `;
    },

    updateSprite(isBoss) {
        const e = document.getElementById('enemy');
        if (isBoss) {
            e.classList.add('is-boss');
        } else {
            e.classList.remove('is-boss');
        }
    },

    animPlayerAtk() {
        const p = document.getElementById('player'); 
        p.classList.remove('hitting'); 
        void p.offsetWidth; 
        p.classList.add('hitting');
        
        const e = document.getElementById('enemy'); 
        setTimeout(() => { 
            e.classList.remove('anim-hit'); 
            void e.offsetWidth; 
            e.classList.add('anim-hit'); 
        }, 100);
    },

    animEnemyAtk() {
        const e = document.getElementById('enemy'); 
        e.classList.remove('anim-atk'); 
        e.style.transform = "scaleX(-1)"; 
        void e.offsetWidth; 
        e.classList.add('anim-atk');
        setTimeout(()=>e.style.transform = "", 200);
        
        const p = document.getElementById('player'); 
        setTimeout(() => { 
            p.classList.remove('anim-hit'); 
            void p.offsetWidth; 
            p.classList.add('anim-hit'); 
        }, 100);
    },

    floatText(msg, target, color, isCrit=false, isEvade=false) { 
        const el = document.createElement('div'); 
        el.className = 'float-text'; 
        if (isCrit) el.classList.add('crit-text'); 
        if (isEvade) el.classList.add('evade-text');
        el.innerText = msg; 
        el.style.color = color;
        
        const rect = document.getElementById(target === 'player' ? 'player-container' : 'enemy-container').getBoundingClientRect();
        const parent = document.getElementById('visual-panel').getBoundingClientRect();
        
        // Randomize position slightly for visual variety
        const offsetX = (Math.random() * 40) - 20;
        const offsetY = (Math.random() * 20) - 10;
        
        el.style.left = (rect.left - parent.left + rect.width/2 + offsetX) + "px";
        el.style.top = (rect.top - parent.top + offsetY) + "px";
        
        document.getElementById('float-layer').appendChild(el);
        setTimeout(()=>el.remove(), 1200);
    },

    log(msg, type) {
        const d = document.createElement('div');
        d.innerText = `[${new Date().toLocaleTimeString('vi-VN', {hour12: false})}] ${msg}`;
        d.style.color = type === 'boss' ? 'var(--boss)' : 
                        type === 'warn' ? '#e53935' : 
                        type === 'accent' ? 'var(--accent)' : '#aaa';
        d.style.borderBottom = "1px solid rgba(255,255,255,0.1)";
        d.style.padding = "5px 0";
        
        const c = document.getElementById('tab-log'); 
        c.prepend(d);
        if(c.children.length > 30) c.lastChild.remove();
    },

    toggleMenu() {
        const m = document.getElementById('main-menu-modal');
        m.classList.toggle('active');
    },

    toggleDetailModal() {
        const m = document.getElementById('detail-modal');
        m.classList.toggle('active');
        if(m.classList.contains('active')) this.updateDetailModal();
    },

    updateDetailModal() {
        if (!document.getElementById('detail-modal').classList.contains('active')) return;
        
        const row = (l, v, c='#fff', tooltip='') => `
            <div class="info-row" ${tooltip ? `title="${tooltip}"` : ''}>
                <span class="info-label">${l}</span>
                <span class="info-val" style="color:${c}">${v}</span>
            </div>`;
        
        // Player Details
        const pDiv = document.getElementById('player-details');
        pDiv.innerHTML = 
            row("C·∫£nh Gi·ªõi", REALMS[state.realm].name, "var(--accent)", "C·∫£nh gi·ªõi tu luy·ªán hi·ªán t·∫°i") +
            row("Giai ƒêo·∫°n", state.stage + 1, "var(--accent)") +
            row("EXP Hi·ªán T·∫°i", `${ui.fmt(state.exp)} / ${ui.fmt(stats.maxExp)}`, "#43a047") +
            row("T·ªëc ƒê·ªô EXP", `${ui.fmt(stats.expRate)}/s`, "#43a047") +
            row("T·∫•n C√¥ng", ui.fmt(stats.atk), "#fff", "S√°t th∆∞∆°ng c∆° b·∫£n m·ªói ƒë√≤n") +
            row("Khi√™n", `${ui.fmt(combat.curShield)} / ${ui.fmt(stats.maxShield)}`, "#64b5f6", "Khi√™n hi·ªán t·∫°i / t·ªëi ƒëa") +
            row("H·ªìi Khi√™n", `+${ui.fmt(stats.shieldRegen)}/s`, "#64b5f6", "Khi√™n h·ªìi ph·ª•c m·ªói gi√¢y") +
            row("H·ªìi M√°u", `+${ui.fmt(stats.hpRegen * stats.hpRegenMult)}/s`, "var(--heal-color)", "M√°u t·ª± h·ªìi m·ªói gi√¢y") +
            row("Ch√≠ M·∫°ng", `${(stats.crit*100).toFixed(1)}% (x${stats.critDmg.toFixed(1)})`, "var(--crit-color)", "T·ªâ l·ªá & s√°t th∆∞∆°ng ch√≠ m·∫°ng") +
            row("T·ªëc ƒê√°nh", `${(1.5/stats.atkSpd).toFixed(2)}s`, "#fff", "Th·ªùi gian gi·ªØa c√°c ƒë√≤n t·∫•n c√¥ng") +
            row("H√∫t M√°u", `${(stats.lifesteal*100).toFixed(1)}%`, "#e57373", "% s√°t th∆∞∆°ng h√∫t th√†nh khi√™n") +
            row("N√© Tr√°nh", `${(stats.evasion*100).toFixed(1)}%`, "#4caf50", "T·ªâ l·ªá n√© ƒë√≤n t·∫•n c√¥ng") +
            row("Ph·∫£n ƒê√≤n", `${(stats.reflect*100).toFixed(1)}%`, "#ff9800", "% s√°t th∆∞∆°ng ph·∫£n l·∫°i k·∫ª ƒë·ªãch") +
            row("Kh√°ng Control", `${(stats.controlResist*100).toFixed(1)}%`, "var(--control-resist)", "Gi·∫£m th·ªùi gian b·ªã cho√°ng") +
            row("S·ªë L·∫ßn ƒê√°nh", stats.multihit.toFixed(1), "#b388ff", "S·ªë l·∫ßn t·∫•n c√¥ng m·ªói l∆∞·ª£t") +
            row("C∆∞·ªùng H√≥a KN", `+${(stats.skillAmp*100).toFixed(1)}%`, "#b388ff", "Hi·ªáu qu·∫£ k·ªπ nƒÉng tƒÉng th√™m");

        // Enemy Details
        const eDiv = document.getElementById('enemy-details');
        eDiv.innerHTML = 
            row("Lo·∫°i", combat.isBoss ? "BOSS Ma V∆∞∆°ng" : "Qu√°i Th∆∞·ªùng", combat.isBoss ? "var(--boss)" : "#fff") +
            row("Sinh L·ª±c", `${ui.fmt(combat.enemyHp)} / ${ui.fmt(combat.enemyMax)}`, "#e53935") +
            row("S·ª©c M·∫°nh", ui.fmt(combat.enemyAtk), "#e53935", "S√°t th∆∞∆°ng m·ªói ƒë√≤n c·ªßa ƒë·ªãch") +
            row("T·ªëc ƒê√°nh", "2.00s", "#fff", "Th·ªùi gian gi·ªØa c√°c ƒë√≤n c·ªßa ƒë·ªãch") +
            row("H·ªá S·ªë M√°u", `${(Math.pow(1.5, state.realm)).toFixed(1)}x Realm`, "#e53935", "Nh√¢n m√°u theo c·∫£nh gi·ªõi") +
            row("T·ªâ L·ªá Boss", `${(stats.bossChance*100).toFixed(1)}%`, "var(--boss)", "X√°c su·∫•t xu·∫•t hi·ªán boss");

        // Advanced Stats
        const aDiv = document.getElementById('advanced-stats');
        aDiv.innerHTML = 
            row("S√°t Th∆∞∆°ng Boss", `${(stats.bossDamageMult*100).toFixed(0)}%`, "#ff5252", "TƒÉng s√°t th∆∞∆°ng l√™n boss") +
            row("Nh√¢n EXP Boss", `${(stats.bossExpBonus*100).toFixed(0)}%`, "#43a047", "EXP nh·∫≠n th√™m t·ª´ boss") +
            row("T·ªëc ƒê·ªô Tu Luy·ªán", `${(stats.cultivateSpeed*100).toFixed(0)}%`, "#64b5f6", "T·ªëc ƒë·ªô t√≠ch l≈©y EXP") +
            row("T·ªâ L·ªá Item Hi·∫øm", `${(stats.rareChance*100).toFixed(2)}%`, "#b388ff", "X√°c su·∫•t r∆°i ƒë·ªì hi·∫øm") +
            row("Nh√¢n To√†n B·ªô", `${((stats.allStatsMult-1)*100).toFixed(1)}%`, "var(--accent)", "Nh√¢n t·∫•t c·∫£ ch·ªâ s·ªë") +
            row("Nh√¢n T·∫•n C√¥ng", `${((stats.allOffenseMult-1)*100).toFixed(1)}%`, "#e53935", "Nh√¢n ch·ªâ s·ªë t·∫•n c√¥ng") +
            row("Nh√¢n Ph√≤ng Th·ªß", `${((stats.allDefenseMult-1)*100).toFixed(1)}%`, "#64b5f6", "Nh√¢n ch·ªâ s·ªë ph√≤ng th·ªß") +
            row("T·ªïng S·ªë ƒê√≤n", ui.fmt(game.totalHits), "#fff", "T·ªïng s·ªë ƒë√≤n ƒë√£ ƒë√°nh") +
            row("Qu√°i Gi·∫øt", ui.fmt(game.totalKills), "#4caf50", "T·ªïng s·ªë qu√°i th∆∞·ªùng ƒë√£ gi·∫øt") +
            row("BOSS Gi·∫øt", ui.fmt(game.totalBossKills), "var(--boss)", "T·ªïng s·ªë boss ƒë√£ gi·∫øt") +
            row("Linh Th·∫°ch Ki·∫øm", ui.fmt(game.totalStonesEarned), "var(--accent)", "T·ªïng linh th·∫°ch ƒë√£ ki·∫øm");
    },

    setTab(t) {
        ['log','shop','guide','updates'].forEach(x => {
            document.getElementById('tab-'+x).style.display = 'none';
        });
        document.getElementById('tab-'+t).style.display = 'block';
        
        document.querySelectorAll('.tab').forEach(e => e.classList.remove('active'));
        document.querySelectorAll('.tab')[['log','shop','guide','updates'].indexOf(t)].classList.add('active');
    }
};

window.onload = () => game.init();
</script>
</body>
</html>
